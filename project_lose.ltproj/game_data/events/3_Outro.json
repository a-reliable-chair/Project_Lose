[
    {
        "name": "Outro",
        "trigger": "level_end",
        "level_nid": "3",
        "condition": "True",
        "commands": [],
        "only_once": false,
        "priority": 20,
        "_source": [
            "transition;close",
            "remove_all_units",
            "change_background;Town",
            "music;Pandemonium",
            "transition;open",
            "if;{v:DavenportRecruited} == 1",
            "    multi_add_portrait;Quinley;Left;Davenport;Right",
            "    s;Quinley;Lemme test dis",
            "    s;Davenport;!",
            "    alert;Cillian has joined the party!",
            "    # Change his portrait",
            "    multi_remove_portrait;Quinley;Davenport",
            "    for;Current_Skill;[u.nid for u in u('Davenport').skills]",
            "        remove_skill;Davenport;{Current_Skill};no_banner",
            "    endf",
            "    give_skill;Davenport;Anticrit;no_banner",
            "    give_skill;Davenport;Canto;no_banner",
            "    # Change unit portrait",
            "    set_name;Davenport;Cillian",
            "    if;not has_achievement('42')",
            "        update_achievement;42;Homecoming;Recruited Cillian in Ch4",
            "        complete_achievement;42;1;banner",
            "    end",
            "end",
            "",
            "if;'{v:ReverseRecruitment}' == 'Yes'",
            "    multi_add_portrait;Shayla;FarLeft;Carlin;MidLeft;Raelin;MidRight;Lamonte;FarRight",
            "    # The party barely made it out and that they're right near the beach/a town entrance",
            "    speak;Shayla;filler",
            "    multi_remove_portrait;Shayla;Raelin;Carlin;Lamonte",
            "    transition;close",
            "    change_background",
            "    music;Imperial Audacity",
            "    add_unit;Cawthorne;3, 18;immediate",
            "    # Add Davenport if alive!",
            "    move_cursor;Cawthorne",
            "    transition;open;500",
            "    wait;250",
            "    move_unit;Cawthorne;1, 23;normal",
            "    wait;500",
            "    add_portrait;Cawthorne;Right",
            "    # Ch 5 boss starts making his way to the beach. Hoping Shallcross hasn't killed the party already.",
            "    # Nearly there, Cawthorne is interrupted by Alpin who just got back in town.",
            "    speak;Cawthorne;Filler.",
            "    remove_portrait;Cawthorne",
            "    wait;250",
            "    move_cursor;0, 5",
            "    music;Hulking Step of the Empire",
            "    add_unit;Alpin;0, 5;fade;push;west",
            "    move_unit;Alpin;2, 11;normal;no_block",
            "    move_unit;Cawthorne;2, 13;normal",
            "    wait;500",
            "    multi_add_portrait;Alpin;Left;Cawthorne;Right",
            "    speak;Alpin;Filler!",
            "    speak;Cawthorne;Filler!",
            "    multi_remove_portrait;Alpin;Cawthorne",
            "    move_unit;Alpin;2, 12;normal",
            "    interact_unit;Alpin;Cawthorne;crit1,end;force_animation",
            "    # They fight and Alpin TINKS real hard, no counter attack.",
            "    wait;250",
            "    multi_add_portrait;Alpin;Left;Cawthorne;Right",
            "    # Baffled, Alpin is terrified, but Cawthorne lets him know of the party's whereabouts and lets him go join them.",
            "    speak;Alpin;Didn't even scratch him!",
            "    speak;Cawthorne;Filler!",
            "    multi_remove_portrait;Alpin;Cawthorne",
            "    move_unit;Alpin;1, 25;normal;push",
            "    wait;250",
            "    add_portrait;Alpin;Right",
            "    # Alpin looks back at the damaged town and is sad D:",
            "    speak;Alpin;filler",
            "    remove_portrait;Alpin",
            "    remove_unit;Alpin;fade;south",
            "else",
            "    multi_add_portrait;Orla;FarLeft;Corridon;MidLeft;Ailsa;MidRight;Quinley;FarRight",
            "    # The party barely made it out and that they're right near the beach/a town entrance",
            "    speak;Orla;filler",
            "    multi_remove_portrait;Orla;Ailsa;Corridon;Quinley",
            "    transition;close",
            "    change_background",
            "    music;Imperial Audacity",
            "    add_unit;Cawthorne;3, 18;immediate",
            "    # Add Davenport if alive!",
            "    move_cursor;Cawthorne",
            "    transition;open;500",
            "    wait;250",
            "    move_unit;Cawthorne;1, 23;normal",
            "    wait;500",
            "    add_portrait;Cawthorne;Right",
            "    # Ch 5 boss starts making his way to the beach. Hoping Shallcross hasn't killed the party already.",
            "    # Nearly there, Cawthorne is interrupted by Laisren who just got back in town.",
            "    speak;Cawthorne;Filler.",
            "    remove_portrait;Cawthorne",
            "    wait;250",
            "    move_cursor;0, 5",
            "    music;Hulking Step of the Empire",
            "    add_unit;Laisren;0, 5;fade;push;west",
            "    move_unit;Laisren;2, 11;normal;no_block",
            "    move_unit;Cawthorne;2, 13;normal",
            "    wait;500",
            "    multi_add_portrait;Laisren;Left;Cawthorne;Right",
            "    speak;Laisren;Filler!",
            "    speak;Cawthorne;Filler!",
            "    multi_remove_portrait;Laisren;Cawthorne",
            "    move_unit;Laisren;2, 12;normal",
            "    interact_unit;Laisren;Cawthorne;crit1,end;force_animation",
            "    # They fight and Laisren TINKS real hard, no counter attack.",
            "    wait;250",
            "    multi_add_portrait;Laisren;Left;Cawthorne;Right",
            "    # Baffled, Laisren is terrified, but Cawthorne lets him know of the party's whereabouts and lets him go join them.",
            "    speak;Laisren;Didn't even scratch him!",
            "    speak;Cawthorne;Filler!",
            "    multi_remove_portrait;Laisren;Cawthorne",
            "    move_unit;Laisren;1, 25;normal;push",
            "    wait;250",
            "    add_portrait;Laisren;Right",
            "    # Laisren looks back at the damaged town and is sad D:",
            "    speak;Laisren;filler",
            "    remove_portrait;Laisren",
            "    remove_unit;Laisren;fade;south",
            "end",
            "wait;250",
            "move_cursor;Cawthorne",
            "wait;250",
            "move_unit;Cawthorne;2, 23;normal",
            "wait;250",
            "add_portrait;Cawthorne;Right",
            "# Cawthorne says that kid will make it more fun; and that it's starting to rain.",
            "speak;Cawthorne;This is gunna be fun! Rain's coming.",
            "remove_portrait;Cawthorne",
            "move_unit;Cawthorne;2, 25;normal",
            "wait;250",
            "remove_unit;Cawthorne;fade;south",
            "wait;500",
            "transition;close",
            "change_background;Plains",
            "#Music BBEG theme",
            "transition;open",
            "multi_add_portrait;Shallcross;Left;SoldierBlue;FarRight;SoldierRed;MidRight",
            "# Outside the town General Shallcross and her goons set up a blockade; she says she's here to witness Cawthorne and that he's in line for a promotion.",
            "speak;Shallcross;filler",
            "speak;SoldierRed;filler",
            "transition;close",
            "multi_remove_portrait;Shallcross;SoldierBlue;SoldierRed",
            "if;not has_achievement('8')",
            "    update_achievement;8;Flashback: Alpin;Visit Alpin's house with Alpin in Ch4",
            "end",
            "if;not has_achievement('9')",
            "    update_achievement;9;Flashback: Lamonte;Visit Leod's house with Lamonte in Ch4",
            "end",
            "if;not has_achievement('10')",
            "    update_achievement;10;Flashback: Garvey;Visit Leod's house with Garvey in Ch4",
            "end",
            "if;not has_achievement('11')",
            "    update_achievement;11;Flashback: Corridon;Visit Corridon's house with Corridon in Ch4",
            "end",
            "if;not has_achievement('20')",
            "    update_achievement;20;That's Not How You Play The Game!;Damage Cawthorne in Ch4",
            "end",
            "if;not has_achievement('21')",
            "    update_achievement;21;Every Party Needs A Pooper;Visit the tavern in Ch4",
            "end",
            "if;not has_achievement('22')",
            "    update_achievement;22;Where'd You Get That Key?!;Open the door next to Corridon's in Ch4",
            "end",
            "if;not has_achievement('23')",
            "    update_achievement;23;Mom, Can We Keep Him?;Escape with a Thrall in Ch4",
            "end"
        ]
    }
]